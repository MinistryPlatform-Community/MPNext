# Session Summary: 2026-02-16 — Docker Build Fix + Trivy Vulnerability Remediation

## Summary

Fixed two CI/CD pipeline failures on the main branch: (1) the Docker build failing due to Next.js 16 Turbopack's inability to fetch Google Fonts in Alpine containers, and (2) Trivy flagging 10 HIGH severity CVEs from `glob` and `tar` bundled with npm in the base image.

## Root Cause Analysis

### Issue 1: Docker Build Failure (Google Fonts + revalidateTag)

The upgrade to Next.js 16 (commit `76e007b`) introduced Turbopack as the default build bundler. Turbopack uses its own TLS stack which cannot establish connections to `fonts.googleapis.com` inside Alpine Linux Docker containers. The build failed with:

```
next/font: error: Failed to fetch `Geist` from Google Fonts.
Hint: Try enabling system TLS certificates with NEXT_TURBOPACK_EXPERIMENTAL_USE_SYSTEM_TLS_CERTS=1
```

Additionally, Next.js 16 changed the `revalidateTag()` API to require a second argument (cache life profile), causing a TypeScript compilation error:

```
Type error: Expected 2 arguments, but got 1.
  revalidateTag('dashboard-data');
```

### Issue 2: Trivy HIGH CVEs (glob, tar)

Trivy flagged 10 HIGH severity vulnerabilities:
- `glob` 10.4.5: CVE-2025-64756 (Command Injection)
- `tar` 6.2.1 / 7.4.3: CVE-2026-23745 (symlink poisoning), CVE-2026-23950 (Unicode collision), CVE-2026-24842 (hardlink path traversal)

Investigation revealed these are **not** project dependencies (neither appears in `package-lock.json`). They come from `npm` itself, which is bundled in the `node:22-alpine` base image. The existing `overrides` in `package.json` for `glob` and `tar` were no-ops.

## Changes Made

### Fix 1: Local Fonts (`src/app/(web)/layout.tsx`)
- Replaced `import { Geist, Geist_Mono } from "next/font/google"` with `geist/font/sans` and `geist/font/mono`
- The `geist` npm package uses `next/font/local` internally, bundling `.woff2` files in `node_modules`
- Same CSS variable names (`--font-geist-sans`, `--font-geist-mono`) — zero visual change
- Eliminates network dependency during `next build`

### Fix 2: revalidateTag API (`src/components/dashboard/actions.ts:101-103`)
- Added `{ expire: 0 }` as 2nd argument to all three `revalidateTag()` calls
- `expire: 0` means immediate cache invalidation (same behavior as before)

### Fix 3: Remove npm from runner image (`Dockerfile:33-35`)
- Added `RUN npm uninstall -g npm` in the runner stage
- Runner only needs `node` binary to execute `server.js` — npm is never used at runtime
- Removes all vulnerable transitive deps (`glob`, `tar`, etc.) from the final image
- Also reduces image size

### Cleanup: Dead overrides (`package.json:74-76`)
- Removed `glob` and `tar` overrides (neither is a project dependency)
- Kept `cross-spawn` override which may affect actual transitive deps

### Auto-generated by Next.js 16 build
- `tsconfig.json`: `jsx: "preserve"` → `"react-jsx"`, added `.next/dev/types/**/*.ts` include
- `next-env.d.ts`: `/// <reference path>` → `import` syntax

## Verification

- `npm run build` succeeds with zero TypeScript errors
- All font CSS variables unchanged (no visual regression)
- Build output shows all 8 routes generated correctly

## Files Modified

| File | Change |
|------|--------|
| `src/app/(web)/layout.tsx` | Switched from `next/font/google` to `geist/font/sans` + `geist/font/mono` |
| `package.json` | Added `geist` dep, removed dead `glob`/`tar` overrides |
| `package-lock.json` | Updated for new dependency |
| `src/components/dashboard/actions.ts` | Added `{ expire: 0 }` 2nd arg to `revalidateTag()` calls |
| `Dockerfile` | Added `npm uninstall -g npm` in runner stage |
| `tsconfig.json` | Auto-updated by Next.js 16 build |
| `next-env.d.ts` | Auto-updated by Next.js 16 build |
| `.claude/work-in-progress.md` | Updated status, environment details, files modified |
| `.claude/session-summary-2026-02-16.md` | This file |
